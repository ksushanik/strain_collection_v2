generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- Core Domain Entities ---

model Sample {
  id           Int        @id @default(autoincrement())
  code         String     @unique // Constructed code, e.g. "24-PL-Rose"
  sampleType   SampleType @map("sample_type")
  siteName     String     @map("site_name")
  lat          Float?
  lng          Float?
  description  String?
  collectedAt  DateTime   @map("collected_at")
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")
  customFields Json?      @map("custom_fields")

  // Relations
  photos  SamplePhoto[]
  strains Strain[]

  @@map("samples")
}

model SamplePhoto {
  id        Int      @id @default(autoincrement())
  sampleId  Int      @map("sample_id")
  url       String
  meta      Json?
  createdAt DateTime @default(now()) @map("created_at")

  sample Sample @relation(fields: [sampleId], references: [id])

  @@map("sample_photos")
}

model Strain {
  id         Int    @id @default(autoincrement())
  identifier String @unique
  sampleId   Int    @map("sample_id")

  // Taxonomy
  taxonomy16s   Json?   @map("taxonomy_16s")
  otherTaxonomy String? @map("other_taxonomy")

  // Indexing
  indexerInitials String? @map("indexer_initials")
  collectionRcam  String? @map("collection_rcam")

  // Characteristics
  seq                Boolean    @default(false)
  biochemistry       String?
  genome             String?
  antibioticActivity String?    @map("antibiotic_activity")
  gramStain          GramStain? @map("gram_stain")

  // Growth
  phosphates       Boolean          @default(false)
  siderophores     Boolean          @default(false)
  pigmentSecretion Boolean          @default(false) @map("pigment_secretion")
  amylase          Amylase?
  isolationRegion  IsolationRegion? @map("isolation_region")
  iuk              String? // Indole acetic acid (IUK in Russian context often refers to IAA)

  features String?
  comments String?

  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")
  customFields Json?    @map("custom_fields")

  // Relations
  sample  Sample          @relation(fields: [sampleId], references: [id])
  media   StrainMedia[]
  storage StrainStorage[]

  @@map("strains")
}

model Media {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  composition String?
  createdAt   DateTime @default(now()) @map("created_at")

  strains StrainMedia[]

  @@map("media")
}

model StrainMedia {
  strainId Int     @map("strain_id")
  mediaId  Int     @map("media_id")
  notes    String?

  strain Strain @relation(fields: [strainId], references: [id])
  media  Media  @relation(fields: [mediaId], references: [id])

  @@id([strainId, mediaId])
  @@map("strain_media")
}

// --- Storage System ---

model StorageBox {
  id          Int      @id @default(autoincrement())
  displayName String   @map("display_name")
  rows        Int // 9 or 10
  cols        Int // 9 or 10
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  cells StorageCell[]

  @@map("storage_boxes")
}

model StorageCell {
  id       Int        @id @default(autoincrement())
  boxId    Int        @map("box_id")
  row      Int
  col      Int
  cellCode String     @map("cell_code") // e.g. "A1"
  status   CellStatus @default(FREE)

  box    StorageBox     @relation(fields: [boxId], references: [id])
  strain StrainStorage?

  @@unique([boxId, row, col])
  @@unique([boxId, cellCode])
  @@map("storage_cells")
}

model StrainStorage {
  id          Int      @id @default(autoincrement())
  strainId    Int      @map("strain_id")
  cellId      Int      @unique @map("cell_id") // One cell = max one strain
  isPrimary   Boolean  @default(false) @map("is_primary")
  allocatedAt DateTime @default(now()) @map("allocated_at")

  strain Strain      @relation(fields: [strainId], references: [id])
  cell   StorageCell @relation(fields: [cellId], references: [id])

  @@map("strain_storage")
}

// --- Flexible Structure & Settings ---

model UiBinding {
  id                Int        @id @default(autoincrement())
  menuLabel         String     @map("menu_label")
  profileKey        ProfileKey @map("profile_key")
  order             Int        @default(0)
  legendId          Int?       @map("legend_id")
  routeSlug         String     @unique @map("route_slug")
  icon              String?
  enabledFieldPacks Json       @map("enabled_field_packs") // List of strings
  updatedAt         DateTime   @updatedAt @map("updated_at")

  legend LegendContent? @relation(fields: [legendId], references: [id])

  @@map("ui_bindings")
}

model LegendContent {
  id        Int      @id @default(autoincrement())
  content   String // Markdown
  updatedAt DateTime @updatedAt @map("updated_at")

  uiBindings UiBinding[]

  @@map("legend_content")
}

// --- Authentication & RBAC ---

model User {
  id       Int     @id @default(autoincrement())
  email    String  @unique
  password String // Hashed
  name     String?

  roleId Int    @map("role_id")
  role   Role   @relation(fields: [roleId], references: [id])

  groupId Int?   @map("group_id")
  group   Group? @relation(fields: [groupId], references: [id])

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  auditLogs AuditLog[]

  @@map("users")
}

model Group {
  id          Int     @id @default(autoincrement())
  name        String  @unique
  description String?
  users       User[]
  permissions Json     @default("{}")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("groups")
}

model Role {
  id          Int     @id @default(autoincrement())
  key         String  @unique
  name        String
  description String?
  permissions Json     @default("{}")
  users       User[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("roles")
}

// --- Enums ---

enum SampleType {
  PLANT
  ANIMAL
  WATER
  SOIL
  OTHER
}

enum GramStain {
  POSITIVE
  NEGATIVE
  VARIABLE
}

enum Amylase {
  POSITIVE
  NEGATIVE
}

enum IsolationRegion {
  RHIZOSPHERE
  ENDOSPHERE
  PHYLLOSPHERE
  SOIL
  OTHER
}

enum CellStatus {
  FREE
  OCCUPIED
}

enum ProfileKey {
  SAMPLE
  STRAIN
  MEDIA
  STORAGE
}

// Audit Log model for tracking all user actions
model AuditLog {
  id     Int  @id @default(autoincrement())
  userId Int  @map("user_id")
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  action   AuditAction
  entity   String // Strain, Sample, User, etc.
  entityId Int         @map("entity_id") // ID of the changed record
  batchId  String?     @map("batch_id")
  comment  String?

  changes  Json? // Details of changes (before/after)
  metadata Json? // Additional information (IP, user agent, etc.)

  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([entity, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  ALLOCATE
  UNALLOCATE
  BULK_ALLOCATE
  CONFIG
}
