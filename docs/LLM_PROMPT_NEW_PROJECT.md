# Техзадание для новой LLM: проект «с нуля» по учёту микробиологических данных

## Роль и режим работы
- Ты — архитектурная и продуктовая LLM, проектируешь новый продукт с нуля.
- Не опирайся на существующий код; используй только требования из файла промта заказчика - docs\промт_для_нового_проекта.md
- При неопределённостях делай разумные допущения, фиксируй их кратко и продолжай работу.

## Цель
- Создать удобную систему учёта с разделами: Главная/Легенда, Образцы, Штаммы, Среды, Хранилище, Аналитика.
- Реализовать «гибкую структуру учёта»: заказчик может менять пользовательские названия разделов и привязку отображаемых данных без изменений БД и бизнес-логики.
- Заложить основу для гео‑привязки, сортировок/фильтров, базовой аналитики.
- Не переносить проблемы старого проекта; опыт прошлого учитывать только как ориентир.

## Термины
- «Образец» — источник отбора микроорганизмов (растение/животное/вода/почва и др.).
- «Штамм» — выделенный микроорганизм с набором характеристик и связей.
- «Среда» — стандартизированная среда для работы с микроорганизмами.
- «Хранилище» — боксы с ячейками, где физически размещаются штаммы.

## Функциональные требования

### Главная
- Легенда терминов и текущей структуры учёта: какой ярлык к какому профилю привязан, какие группы полей активны.
- Короткая сводка метрик и быстрые ссылки на разделы.

### Образцы
- Список плитками; на плитке отображать: название/код, точка отбора (текст), дата отбора.
- Детальная карточка:
  - Конструктор кода из трёх частей: № образца + тип (растение/животное/вода/почва) + название вида.
  - Место отбора: словесное название + координаты; карта по координатам (желательно, но не критично).
  - Описание объекта (текст), фото (место/объект), дата отбора (сортируемо).
  - Возможность сортировать/фильтровать по месту и дате.
  - Табличный список связанных штаммов.

### Штаммы
- Табличное представление с фильтрами/сортировками. Поля:
  - Идентификатор (название штамма), № образца (связь), 16S rRNA Taxonomy, другие варианты определения.
  - Индекс (инициалы выделившего), Collection RCAM, SEQ (+/−).
  - Biochemistry (текст), Genome (текст), Антибиотическая активность (текст).
  - Место хранения (минимум два места), Среды роста (несколько).
  - Фосфаты (булево), Синтез сидерофоров (булево), Выделение пигментов (булево).
  - Окраска по грамму (enum), ИУК (text/enum), Амилаза (enum).
  - Область выделения (ризосфера/эндосфера...), Особенности, Комментарии.

### Среды
- Плитки с названием и составом; поиск, добавление/редактирование.

### Хранилище
- Плитки боксов, всегда видимые.
- Создание боксов фиксированных размеров: 9×9 или 10×10.
- Сетка ячеек со статусом «свободно/занято» по цвету.
- Клик по занятой — переход к связанному штамму; по свободной — назначение штамма.
- Массовые операции: пакетное назначение/снятие в выбранный диапазон ячеек.

### Аналитика
- Заглушка с базовыми метриками и готовностью к расширению.

## Гибкая структура учёта
- Введи «доменные профили» с фиксированной семантикой: `sample`, `strain`, `media`, `storage`.
- Введи «UI‑биндинги»:
  - Каждый ярлык меню привязывается к одному профилю.
  - Биндинг определяет: набор отображаемых полей, тип представления (плитка/таблица/карта), доступные действия.
  - Администратор может менять биндинги: например, «Образцы» → профиль `strain`, «Штаммы» → профиль `sample`.
- Введи «пакеты полей» (field packs):
  - Для каждого профиля определяются кластеры полей (обязательные/опциональные).
  - Админ включает/выключает пакеты, UI и валидация подстраиваются.
- Страница «Легенда» автоматически отражает текущие биндинги и активные пакеты.

## Модель данных (новая)
- `samples`:
  - `id`, `code` (уникальный, из конструктора), `sample_type` (enum: plant|animal|water|soil),
  - `site_name`, `lat`, `lng`, `description`, `collected_at`,
  - `created_at`, `updated_at`, `custom_fields` (json для расширений).
- `sample_photos`:
  - `id`, `sample_id` fk, `url`, `meta` (json), `created_at`.
- `strains`:
  - `id`, `identifier` (уникальный), `sample_id` fk,
  - `taxonomy_16s` (json), `other_taxonomy` (text),
  - `indexer_initials` (string), `collection_rcam` (text),
  - `seq` (boolean), `biochemistry` (text), `genome` (text),
  - `antibiotic_activity` (text), `gram_stain` (enum),
  - `phosphates` (boolean), `siderophores` (boolean), `pigment_secretion` (boolean),
  - `iuk` (text/enum), `amylase` (enum), `isolation_region` (enum),
  - `features` (text), `comments` (text),
  - `created_at`, `updated_at`, `custom_fields` (json).
- `media`:
  - `id`, `name` (уникальный), `composition` (text), `created_at`.
- `strain_media`:
  - `strain_id` fk, `media_id` fk, `notes` (text), `unique(strain_id, media_id)`.
- `storage_boxes`:
  - `id`, `display_name`, `rows` (enum: 9|10), `cols` (enum: 9|10), `description`, `created_at`, `updated_at`.
- `storage_cells`:
  - `id`, `box_id` fk, `row`, `col`, `cell_code`, `status` (enum: free|occupied), `unique(box_id, row, col)`.
- `strain_storage`:
  - `id`, `strain_id` fk, `cell_id` fk, `is_primary` (boolean), `allocated_at`.
  - Ограничение: одна ячейка связана максимум с одним штаммом; у штамма может быть несколько ячеек.
- `ui_bindings`:
  - `id`, `menu_label` (string), `profile_key` (enum: sample|strain|media|storage), `enabled_field_packs` (list), `updated_at`.
- `legend_content`:
  - `id`, `content` (text/markdown), `updated_at`.
- `audit_log`:
  - `id`, `action` (enum), `entity_type`, `entity_id`, `user_id/batch_id`, `comment`, `created_at`.

## API требования
- Версионирование: `GET /api/v1/*`, обязательная OpenAPI‑спека.
- Settings:
  - `GET/PUT /settings/ui-bindings` — получить/обновить биндинги.
  - `GET/PUT /settings/legend` — получить/обновить легенду.
- Samples:
  - `GET /samples` — фильтры: `search`, `type`, `site`, `date_from`, `date_to`, пагинация.
  - `POST /samples` — создать; отдельная валидация конструктора кода.
  - `GET /samples/{id}` — детали: место, координаты, фото, связанные штаммы.
  - `PUT /samples/{id}` — обновить; `POST /samples/{id}/photos` — добавить; `DELETE` — удалить фото.
- Strains:
  - `GET /strains` — фильтры: `seq`, `genome`, `gram_stain`, `taxonomy`, `sample_code`, пагинация.
  - `POST /strains`, `GET /strains/{id}`, `PUT /strains/{id}`.
  - `POST /strains/{id}/media` — привязать среду; `DELETE` — отвязать.
- Media:
  - `GET /media` — поиск; `POST /media`; `GET/PUT /media/{id}`.
- Storage:
  - `GET /storage/boxes` — список и краткая сводка занятости.
  - `POST /storage/boxes` — создать (rows/cols ∈ {9,10}); `PUT /storage/boxes/{id}` — обновить.
  - `GET /storage/boxes/{id}` — детали и сетка ячеек.
  - `POST /storage/boxes/{box_id}/cells/{cell_code}/allocate` — назначить штамм, флаг `is_primary`.
  - `DELETE /storage/boxes/{box_id}/cells/{cell_code}/unallocate` — снять.
  - `POST /storage/boxes/{box_id}/bulk-allocate` — пакетное размещение.
- Analytics:
  - `GET /analytics/overview` — заглушка: `total_strains`, `total_samples`, `occupied/free_cells`, `recent_additions`.

## UI/UX требования
- Единый стиль, доступные компоненты, отзывчивый дизайн.
- Образцы — плитки; при раскрытии — карта, фото‑галерея, таблица штаммов.
- Штаммы — таблица; быстрые фильтры и сортировки.
- Среды — плитки; простые формы.
- Хранилище — интерактивная сетка; диалоги действий; пакетные операции.
- Легенда — понятная «карта терминов» и активных паков полей.
- Все страницы подчиняются текущим `ui_bindings` (динамические представления).

## Нефункциональные требования
- Валидация: строгая на клиенте и сервере, читаемые сообщения.
- Аудит: `CREATE/UPDATE/DELETE/ALLOCATE/UNALLOCATE/BULK_ALLOCATE` с `batch_id` для массовых действий.
- Производительность: индексы по ключевым полям и датам; пагинация; кэш запросов.
- Надёжность: транзакции при назначениях и пакетных операциях; консистентность статусов ячеек.
- Файлы: фото — внешнее хранилище (S3/MinIO); в базе — URL/метаданные.
- Безопасность: санитизация ввода, проверка файлов, минимально необходимые права.

## Выбор стека (для предложения и аргументации)
- Вариант 1 (единый язык TypeScript): Frontend — Next.js; Backend — NestJS/Fastify; ORM — Prisma; БД — PostgreSQL (+ PostGIS при необходимости); карта — Leaflet/Mapbox.
- Вариант 2 (Python‑бэкенд): Backend — FastAPI + SQLAlchemy + Pydantic; Frontend — React/Next.js; БД — PostgreSQL.
- Обоснуй выбор, опиши миграции/CI/CD, реализацию «гибкой структуры учёта» через `ui_bindings` и «пакеты полей`.

## Артефакты на выходе
- Архитектурный обзор (слои, модули, потоки).
- ER‑диаграмма БД с ключами/индексами.
- OpenAPI‑спека всех ручек.
- Формат `ui_bindings` и «пакетов полей», примеры конфигураций.
- Описательные вайрфреймы страниц.
- План миграций, сидов и окружений (`dev/test/prod`).
- Тест‑стратегия: unit/integration/e2e; базовые сценарии.
- Этапы реализации с оценками и рисками.

## Критерии приёмки
- CRUD по `samples/strains/media` с рабочими фильтрами/сортировками.
- Хранилище: создание боксов 9×9/10×10; сетка; `allocate/unallocate/bulk`.
- Смена `ui_bindings` меняет представления и формы без изменения БД.
- Легенда отражает текущую конфигурацию; фото/карта для образцов работают.
- Аудит заполняется для всех действий.
- OpenAPI полная и синхронизирована с реализацией.

## Этапы реализации
- Этап 1: схема БД и миграции (`samples`, `strains`, `media`, `storage_*`, `ui_bindings`, `legend_content`, `audit_log`).
- Этап 2: бэкенд API (`settings/samples/strains/media/storage`) + валидации.
- Этап 3: фронтенд страницы и компоненты; карты и фото.
- Этап 4: пакетные операции и аудит.
- Этап 5: тесты (unit/integration/e2e).
- Этап 6: аналитика‑заглушка и метрики.
- Этап 7: докеризация/CI, окружения и деплой.

## Ограничения
- Не наследовать код/модели старого проекта; всё спроектировать заново.
- Канонические профили (`sample`, `strain`, `media`, `storage`) неизменны; гибкость через `ui_bindings` и «пакеты полей».
- Одна ячейка хранилища — максимум один штамм; у штамма допустимо несколько мест хранения.