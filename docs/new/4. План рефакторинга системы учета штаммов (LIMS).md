
# План рефакторинга системы учета штаммов (LIMS)

Роль: Senior Full-Stack Developer / Bioinformatician Architect.

Цель: Трансформация существующей системы учета (culturedb) из формата "лабораторный журнал" в научную базу данных, соответствующую стандартам WDCM/MIGS.

Контекст:

- Существует сущность `Strain` (Штамм).
    
- Поле `taxonomy_id` уже заполняется через NCBI Taxonomy API.
    
- Текущая реализация "признаков" (чекбоксы, фиксированные поля) не масштабируема и научно некорректна.
    

---

## 1. Рефакторинг Базы Данных (Schema Design)

Необходимо уйти от плоской структуры таблицы `strains` к реляционной модели или использованию JSONB для гибких свойств.

### А. Таблица `strains` (Очистка)

Убрать из основной таблицы `strains` специфические поля (`amylase`, `pigment`, `siderophores`). Оставить только паспортные данные:

- `id` (UUID/Int)
    
- `internal_id` (String) - _Например: Hz 1 MP_
    
- `ncbi_taxonomy_id` (Int) - _Связь с NCBI_
    
- `ncbi_scientific_name` (String) - _Кэшируем имя на момент создания_
    
- `sample_id` (FK) - _Связь с образцом_
    
- `isolator_person_id` (FK) - _Кто выделил (User)_
    
- `isolation_date` (Date)
    
- `biosafety_level` (Enum: RG1, RG2, RG3) - _Критично для патогенов_
    
- `status` (Enum: Active, Consumed, Lost)
    

### Б. Новая таблица `strain_phenotypes` (Вместо чекбоксов)

Реализация паттерна EAV (Entity-Attribute-Value) или структурированной таблицы для хранения биохимических свойств.

- `strain_id` (FK)
    
- `trait_name` (String) - _Например: "Phosphate Solubilization", "Gram Stain"_
    
- `result_value` (String/Boolean) - _Например: "+", "Negative", "5mm halo"_
    
- `method_used` (String) - _Например: "Pikovskaya Medium", "Microscopy"_
    
- `experimental_conditions` (Text/JSON) - _Например: {"temp": 28, "time": "48h"}_
    

### В. Новая таблица `strain_genetics` (Геномный паспорт)

- `strain_id` (FK)
    
- `marker_16s_accession` (String) - _GenBank ID_
    
- `marker_16s_sequence` (Text) - _FASTA string (для поиска)_
    
- `wgs_accession` (String)
    
- `wgs_status` (Enum: Draft, Complete)
    
- `genome_size_mb` (Decimal)
    
- `gc_content_percent` (Decimal)
    

### Г. Обновление `inventory_allocations` (Склад)

Добавить управление типами стоков.

- Добавить поле `stock_type` (Enum: `Master Bank`, `Working Bank`).
    
- Добавить поле `passage_number` (Int) - _Номер пассажа_.
    
- Добавить поле `parent_strain_id` (FK) - _Если это суб-культура_.
    

---

## 2. Бизнес-логика и Валидация (Backend)

### А. "Умная" валидация таксономии (Taxonomy Rules Engine)

Поскольку мы знаем NCBI ID, мы должны предотвращать биологические ошибки.

- **Задача:** Создать `TaxonomyObserver` или Service.
    
- **Логика:**
    
    1. При сохранении штамма проверять `ncbi_scientific_name`.
        
    2. Если род == _Stenotrophomonas_ (или входит в список известных _Gammaproteobacteria_), то:
        
        - Автоматически устанавливать свойство `Gram Stain` = `Negative`.
            
        - Блокировать попытку пользователя сохранить `Gram +` с ошибкой "Биологическое несоответствие: Род Stenotrophomonas является грамотрицательным".
            

### Б. API для свойств (Traits API)

Вместо хардкода полей (`is_amylase_active`), создать эндпоинты для управления свойствами:

- `POST /api/strains/{id}/traits` -> Добавить свойство (Название: "Amylase", Результат: "+", Метод: "Starch Agar").
    
- `GET /api/strains/{id}/traits` -> Получить список всех свойств.
    

---

## 3. UI/UX (Frontend)

Изменить страницу `Edit Strain`. Вместо длинного списка ("портянки") внедрить **Tab-интерфейс**.

### Вкладка 1: "Паспорт" (Passport Data)

- Поля: Идентификаторы, Выбор таксономии (NCBI компонент), Ссылка на Образец (карточка с превью места сбора), Дата выделения, Уровень биобезопасности.
    
- _Важно:_ Отображать предупреждение, если выбран патоген (RG2).
    

### Вкладка 2: "Фенотип" (Phenotype)

- **Удалить:** Статичные селекты (Амилаза, ИУК) и чекбоксы (SEQ, Фосфаты).
    
- **Добавить:** Динамическую таблицу "Свойства и Тесты".
    
    - Кнопка "Добавить свойство".
        
    - При добавлении модальное окно: "Выберите свойство" (автокомплит), "Результат", "Метод".
        
- _Пример:_ Пользователь добавляет "Сидерофоры" -> Выбирает результат "Положительный" -> Указывает метод "CAS-test".
    

### Вкладка 3: "Генотип" (Genotype)

- Поля для ввода Accession Numbers (с кнопкой-ссылкой на NCBI).
    
- Поле для загрузки FASTA (или текстовое поле) с моноширинным шрифтом.
    
- Блок WGS (Whole Genome) с полями качества сборки.
    

### Вкладка 4: "Хранение" (Inventory)

- Таблица размещений.
    
- Визуальное отличие для **Master Bank** (например, иконка замка/золотой цвет) и **Working Bank**.
    
- Кнопка "Создать рабочий сток из мастера" (Create sub-culture).
    

---

## 4. План миграции данных (Data Migration Strategy)

Если в базе уже есть данные:

1. **Map existing fields:**
    
    - Значение из поля `amylase` (table `strains`) -> перенести в новую таблицу `strain_phenotypes` (Trait: "Amylase Activity", Method: "Unknown/Legacy").
        
    - Чекбокс `phosphates` -> если `true`, создать запись в `strain_phenotypes` (Trait: "Phosphate Solubilization", Result: "Positive").
        
    - Чекбокс `sequenced` -> перенести в статус `genetics_present` (boolean) или оставить в заметках, пока не будут введены реальные данные (Accession No).
        
2. **Drop columns:** После миграции удалить старые колонки (`amylase`, `is_sequenced`, etc.) из таблицы `strains`.